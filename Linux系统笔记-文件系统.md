# Linux系统

## 文件系统

- 基本概念
  
  - 文件是一个长度>=0的序列，可包含任意信息，文件系统不关心文件的格式。
  - Linux使用虚拟文件系统（VFS）支持很多文件系统，其中Linux主要使用ext2。
  - 每个文件都可以通过**绝对路径**或**工作目录+相对路径**的方法表示。
  - Linux支持字符特殊文件和块特殊文件。字符特殊文件用于模拟I/O设备（键盘），而块特殊设备用于直接向硬盘中写入数据的操作，会跳过文件系统。
  - Linux使用POSIX提供的读写锁来保护文件。

- 虚拟文件系统（VFS）
  
  - 虚拟文件系统的用途：与本地/远程设备的不同文件系统进行交互。
  - VFS支持四个文件相关的抽象：
    - 超级块superBlock：包括文件系统的关键信息。破坏超级块会导致文件系统破坏。
    - i节点inode：表示某一个确切的文件。
    - dentry：表示某一个目录项，如/usr/ast。
    - file数据结构：一个打开的文件在内存中的表示。
  - VFS下层需要实现VFS规定的接口。VFS的api实现为下层文件系统实现的函数指针。
  
- ext2文件系统
  
  - ext2文件系统保留块0用于启动系统，之后将磁盘划分为若干个块组，每个组的结构如下：
    - 超级块：描述文件系统信息。包括inode个数、磁盘块数、空闲块链表头。
    - 组描述符：存放块位图和inode位图的位置、空闲块数、已占用的inode个数、组中目录个数等。
    - 块位图和inode位图：记录每个块和每个inode的占用情况。块数是分区之后固定不变的，而inode数量比实际需要的inode大很多。
    - inode集中存储区：对应每个数据/目录文件的信息，包括统计信息和存放文件数据的磁盘块地址。
    - 数据区：存放所有文件和目录。
  - 一个文件的所有块不需要连续，也不需要位于同一个块组中。
  - 访问文件时必须在上层调用open。open需要解析得到绝对路径/相对路径，并从根目录/工作目录开始查找目录文件。
    - 每个目录都由整数个块构成，便于整体写入磁盘。
    - 每个目录项由5个域构成：inode号、目录项大小、文件类型、文件名长度、文件名。其中目录项大小可用于寻找下一个目录项。
    - 由于查找目录是线性的，因此使用目录缓存加快查找。
      - 每次线性查找过程中经过的所有目录项都被存入缓存。
      - 例如：查找绝对目录/usr/ast，则缓存中会加入/、/usr、/usr/ast三个目录项的inode编号。
    - 如果文件存在，则将其inode装入内核inode表中，将文件装入内存。
  - 文件打开之后需要被读取/写入，假设有如下系统调用：n = read(fd. buffer, nBytes);
    - 内核需要通过fd找到文件对应的inode。
      - 因为fd表明了读写文件的起始地址，而不同进程对同一文件的读写位置不一致，所以引入打开文件描述表，作为fd和inode的中间层。打开文件描述表记录进程对fd的操作位置，其他父子进程可以直接继承。
      - 打开文件描述表的最大优势在于使同一进程组的进程可以共享整个文件的读写位置，而给不同进程组的进程设定各自不同的读写位置。
    - inode包括对磁盘块的多级索引。inode通过多级索引的方式支持大文件的寻址。

- ext4文件系统作出的改进

  - ext2要求每次创建数据块之后立刻写入磁盘，以防止由于不可抗力造成的数据丢失。磁盘的寻道延迟成为了ext2文件系统的性能瓶颈。
  - ext4文件系统维护一个日志用于记录所有文件系统操作。
    - 日志是一个环形缓冲器，提供对文件系统的读写操作记录。
    - 日志本身由日志块设备（JBD）执行读写操作。
      - JBD支持的主要功能：日志记录、原子操作处理、事务。
        - 日志记录描述所有改变块数据的行为；
        - 原子操作处理保证对一次write改动的多个块可以被原子更改；
        - 事务维持了一组日志记录，仅当一个事务的所有记录均执行完成时才允许丢弃这个事务的日志记录。
  - 可以把文件操作分为只改变元数据和改变数据两种。不记录所有数据而只记录元数据可有效降低系统开销，而牺牲了部分可靠性。
  - ext4支持一次分配多个连续的存储块。

- proc文件系统

  - 该系统为每个进程在/proc中创建目录，目录名称为pid。该目录存放进程信息文件，如命令行、环境变量、信号等。当读取这些文件时，系统才创建这个文件。
